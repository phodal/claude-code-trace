<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Code Metrics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        .card {
            @apply bg-white rounded-lg shadow-md p-6;
        }
        .stat-value {
            @apply text-3xl font-bold text-gray-800;
        }
        .stat-label {
            @apply text-sm text-gray-500 uppercase tracking-wide;
        }
        .tab-active {
            @apply border-b-2 border-blue-500 text-blue-600;
        }
        .tab-inactive {
            @apply text-gray-500 hover:text-gray-700;
        }
        .tool-badge {
            @apply px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800;
        }
        .edit-badge {
            @apply px-2 py-1 text-xs rounded-full bg-green-100 text-green-800;
        }
        .error-badge {
            @apply px-2 py-1 text-xs rounded-full bg-red-100 text-red-800;
        }
        .expandable-row {
            cursor: pointer;
        }
        .expandable-row:hover {
            @apply bg-gray-50;
        }
        .tool-call-detail {
            @apply bg-gray-50 border-l-4 border-blue-200;
        }
        .message-preview-cell {
            cursor: help;
        }
        .message-full-tooltip {
            display: none;
            position: fixed;
            z-index: 9999;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 600px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            color: #374151;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-800">Claude Code Metrics Dashboard</h1>
            <p class="text-gray-600 mt-2">Real-time observability for AI Agent usage - User → Session → Message → ToolCalls</p>
        </header>

        <!-- Summary Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="card">
                <div class="stat-label">Total Requests</div>
                <div class="stat-value" th:text="${totalRequests}">0</div>
            </div>
            <div class="card">
                <div class="stat-label">Total Tool Calls</div>
                <div class="stat-value" th:text="${totalToolCalls}">0</div>
            </div>
            <div class="card">
                <div class="stat-label">Edit Tool Calls</div>
                <div class="stat-value text-blue-600" th:text="${totalEditToolCalls}">0</div>
            </div>
            <div class="card">
                <div class="stat-label">Lines Modified</div>
                <div class="stat-value text-green-600" th:text="${totalLinesModified}">0</div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="card">
                <div class="stat-label">Input Tokens</div>
                <div class="stat-value text-purple-600" th:text="${totalInputTokens}">0</div>
            </div>
            <div class="card">
                <div class="stat-label">Output Tokens</div>
                <div class="stat-value text-orange-600" th:text="${totalOutputTokens}">0</div>
            </div>
            <div class="card">
                <div class="stat-label">Active Users</div>
                <div class="stat-value text-indigo-600" th:text="${activeUsers}">0</div>
            </div>
            <div class="card">
                <div class="stat-label">Avg Tool Calls/Request</div>
                <div class="stat-value" th:text="${totalRequests > 0 ? #numbers.formatDecimal(totalToolCalls / totalRequests, 1, 2) : '0'}">0</div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="card mb-8">
            <div class="border-b border-gray-200 mb-4">
                <nav class="-mb-px flex space-x-8">
                    <button onclick="showTab('turns')" id="tab-turns" class="py-2 px-1 tab-active font-medium text-sm">
                        Messages (Turns)
                    </button>
                    <button onclick="showTab('otel')" id="tab-otel" class="py-2 px-1 tab-inactive font-medium text-sm">
                        OTEL Linked Turns
                    </button>
                    <button onclick="showTab('sessions')" id="tab-sessions" class="py-2 px-1 tab-inactive font-medium text-sm">
                        Sessions
                    </button>
                    <button onclick="showTab('users')" id="tab-users" class="py-2 px-1 tab-inactive font-medium text-sm">
                        Users
                    </button>
                    <button onclick="showTab('tools')" id="tab-tools" class="py-2 px-1 tab-inactive font-medium text-sm">
                        Tool Performance
                    </button>
                    <button onclick="showTab('skills')" id="tab-skills" class="py-2 px-1 tab-inactive font-medium text-sm">
                        Skills
                    </button>
                </nav>
            </div>
            
            <!-- Turns Tab -->
            <div id="content-turns" class="tab-content">
                <h2 class="text-xl font-semibold mb-4">Recent Messages (Tool Calls breakdown)</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="turns-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Message Preview</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Model</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tool Calls (Total / non-edit)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Edits/Lines</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tokens</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Latency</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="turns-body">
                            <tr>
                                <td colspan="8" class="px-4 py-4 text-center text-gray-500">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- OTEL Linked Turns Tab -->
            <div id="content-otel" class="tab-content hidden">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-xl font-semibold">OTEL Linked Turns (inferred)</h2>
                        <p class="text-sm text-gray-500 mt-1">Chains are inferred by matching tool_use ids emitted ↔ consumed across multiple /messages calls.</p>
                    </div>
                    <button onclick="loadOtelChains()" class="text-sm px-3 py-2 rounded bg-gray-900 text-white hover:bg-gray-800">Refresh</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="otel-chains-table">
                        <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Model</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Traces</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ToolUse</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tool Calls</th>
                        </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="otel-chains-body">
                        <tr>
                            <td colspan="6" class="px-4 py-4 text-center text-gray-500">Loading...</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Sessions Tab -->
            <div id="content-sessions" class="tab-content hidden">
                <div class="mb-4">
                    <h2 class="text-xl font-semibold">User Sessions</h2>
                    <p class="text-sm text-gray-500 mt-1">Click on a session to view all messages for that user</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="sessions-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">First Seen</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Activity</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Messages</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tool Calls</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg TC/Message</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tokens (In/Out)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lines Modified</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="sessions-body">
                            <tr>
                                <td colspan="8" class="px-4 py-4 text-center text-gray-500">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Users Tab -->
            <div id="content-users" class="tab-content hidden">
                <h2 class="text-xl font-semibold mb-4">User Metrics</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requests</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tool Calls</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Edit Tools</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lines Modified</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Input Tokens</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Output Tokens</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Seen</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr th:each="user : ${userMetrics}">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    <a th:href="@{'/metrics?user=' + ${user.userId}}" class="text-blue-600 hover:underline" th:text="${user.userId}">-</a>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="${user.totalRequests}">0</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="${user.totalToolCalls}">0</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600" th:text="${user.editToolCalls}">0</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600" th:text="${user.linesModified}">0</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-purple-600" th:text="${user.inputTokens}">0</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-orange-600" th:text="${user.outputTokens}">0</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="${user.lastSeen}">-</td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(userMetrics)}">
                                <td colspan="8" class="px-6 py-4 text-center text-gray-500">No user data yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Tools Tab -->
            <div id="content-tools" class="tab-content hidden">
                <div class="mb-4">
                    <h2 class="text-xl font-semibold">Tool Performance Matrix</h2>
                    <p class="text-sm text-gray-500 mt-1">Performance metrics and usage statistics for all tools</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="tools-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tool Name</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Calls</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Success Rate</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Lines Changed</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="tools-body">
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-center text-gray-500">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Skills Tab -->
            <div id="content-skills" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold">Skills Statistics</h2>
                    <p class="text-sm text-gray-500 mt-1">Usage statistics for AI agent skills</p>
                </div>
                
                <!-- Skills Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6" id="skills-summary">
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 border border-purple-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm text-purple-600 font-medium">Total Skills</div>
                                <div class="text-2xl font-bold text-purple-900" id="total-skills">-</div>
                            </div>
                            <svg class="w-10 h-10 text-purple-400" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm text-blue-600 font-medium">Total Calls</div>
                                <div class="text-2xl font-bold text-blue-900" id="total-skill-calls">-</div>
                            </div>
                            <svg class="w-10 h-10 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border border-green-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm text-green-600 font-medium">Avg Success Rate</div>
                                <div class="text-2xl font-bold text-green-900" id="avg-skill-success">-</div>
                            </div>
                            <svg class="w-10 h-10 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="skills-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Skill Name</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Calls</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Success Rate</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Last Used</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="skills-body">
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-center text-gray-500">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tool Call Detail Modal -->
        <div id="tool-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Tool Call Details</h3>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="modal-content"></div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.classList.remove('tab-active');
                el.classList.add('tab-inactive');
            });
            
            document.getElementById('content-' + tabName).classList.remove('hidden');
            document.getElementById('tab-' + tabName).classList.remove('tab-inactive');
            document.getElementById('tab-' + tabName).classList.add('tab-active');
            
            if (tabName === 'turns') loadTurns();
            if (tabName === 'otel') loadOtelChains();
            if (tabName === 'sessions') loadSessions();
            if (tabName === 'tools') loadToolPerformance();
            if (tabName === 'skills') loadSkills();
        }
        
        // Load turns data
        async function loadTurns() {
            try {
                const response = await fetch('/metrics/api/turns');
                const turns = await response.json();
                renderTurns(turns);
            } catch (e) {
                console.error('Failed to load turns:', e);
            }
        }
        
        function renderTurns(turns) {
            const tbody = document.getElementById('turns-body');
            if (turns.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-4 text-center text-gray-500">No messages yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = turns.map(turn => {
                // Generate better preview when lastUserMessagePreview is empty
                const messagePreview = turn.lastUserMessagePreview && turn.lastUserMessagePreview.trim() !== '' && turn.lastUserMessagePreview !== 'null'
                    ? turn.lastUserMessagePreview
                    : (turn.toolCalls && turn.toolCalls.length > 0 
                        ? `[${turn.toolCalls.length} tool call${turn.toolCalls.length > 1 ? 's' : ''}: ${turn.toolCalls.map(tc => tc.name || 'unknown').slice(0, 3).join(', ')}${turn.toolCalls.length > 3 ? '...' : ''}]`
                        : '[No message content]');
                
                const total = Number(turn.toolCallCountTotal || 0);
                const nonEdit = Number(turn.toolCallCount || 0);
                const edit = Number(turn.editToolCallCount || 0);
                
                return `
                <tr class="expandable-row" onclick="toggleTurnDetail('${turn.turnId}')">
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatTime(turn.timestamp)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${truncate(turn.userId, 15)}</td>
                    <td class="px-4 py-3 text-sm text-gray-500 max-w-xs">
                        <div class="message-preview-cell" data-turn-id="${turn.turnId}" data-preview-message="${escapeHtml(messagePreview)}">${escapeHtml(truncate(messagePreview, 50))}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${turn.model || '-'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                        ${(() => {
                            if (total <= 0 && nonEdit <= 0 && edit <= 0) return '<span class="text-gray-400">-</span>';
                            const totalBadge = total > 0 ? `<span class="tool-badge">${total} total</span>` : '';
                            const nonEditBadge = nonEdit > 0 ? `<span class="tool-badge ml-2">${nonEdit} non-edit</span>` : `<span class="text-gray-400 ml-2">0 non-edit</span>`;
                            return `<div class="flex items-center">${totalBadge}${nonEditBadge}</div>`;
                        })()}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                        ${turn.editToolCallCount > 0 ? `<span class="edit-badge">${turn.editToolCallCount} edits</span> <span class="text-green-600">+${turn.linesAdded || 0}</span> <span class="text-red-600">-${turn.linesRemoved || 0}</span>` : '<span class="text-gray-400">-</span>'}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${turn.promptTokens || 0} / ${turn.completionTokens || 0}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${turn.latencyMs ? turn.latencyMs + 'ms' : '-'}</td>
                </tr>
                <tr id="detail-${turn.turnId}" class="hidden tool-call-detail">
                    <td colspan="8" class="px-4 py-3">
                        ${renderToolCalls(turn.toolCalls || [])}
                    </td>
                </tr>
            `;
            }).join('');
        }
        
        function renderToolCalls(toolCalls) {
            if (toolCalls.length === 0) {
                return '<div class="text-gray-500 text-sm">No tool calls recorded in this message</div>';
            }
            
            // Separate edit and non-edit tool calls
            const editCalls = toolCalls.filter(tc => tc.filePath && tc.filePath.trim() !== '');
            const nonEditCalls = toolCalls.filter(tc => !tc.filePath || tc.filePath.trim() === '');
            
            let html = '<div class="space-y-3">';
            
            // Render non-edit tool calls if any
            if (nonEditCalls.length > 0) {
                html += `
                    <div>
                        <div class="font-medium text-sm text-gray-700 mb-2">Non-Edit Tool Calls (${nonEditCalls.length}):</div>
                        <div class="space-y-2">
                            ${nonEditCalls.map(tc => `
                                <div class="bg-blue-50 p-3 rounded border border-blue-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <span class="font-medium text-sm">${tc.name || 'unknown'}</span>
                                            ${tc.id ? `<span class="ml-2 text-xs text-gray-500 font-mono">${truncate(tc.id, 20)}</span>` : ''}
                                        </div>
                                        <span class="text-xs px-2 py-0.5 rounded ${tc.status === 'ok' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${tc.status || 'ok'}</span>
                                    </div>
                                    ${tc.argsPreview ? `<div class="mt-1 text-xs text-gray-600 font-mono bg-white p-2 rounded overflow-x-auto">${escapeHtml(tc.argsPreview)}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Render edit tool calls if any
            if (editCalls.length > 0) {
                html += `
                    <div>
                        <div class="font-medium text-sm text-gray-700 mb-2">Edit Tool Calls (${editCalls.length}):</div>
                        <div class="space-y-2">
                            ${editCalls.map(tc => `
                                <div class="bg-green-50 p-3 rounded border border-green-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <span class="font-medium text-sm">${tc.name || 'FileEdit'}</span>
                                            ${tc.filePath ? `<span class="ml-2 text-xs text-gray-500 font-mono">${truncate(tc.filePath, 40)}</span>` : ''}
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            ${(tc.linesAdded > 0 || tc.linesRemoved > 0) ? `
                                                <span class="text-xs">
                                                    <span class="text-green-600 font-medium">+${tc.linesAdded || 0}</span>
                                                    <span class="text-red-600 font-medium">-${tc.linesRemoved || 0}</span>
                                                </span>
                                            ` : ''}
                                            <span class="text-xs px-2 py-0.5 rounded ${tc.status === 'ok' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${tc.status || 'ok'}</span>
                                        </div>
                                    </div>
                                    ${tc.argsPreview ? `<div class="mt-1 text-xs text-gray-600 font-mono bg-white p-2 rounded overflow-x-auto">${escapeHtml(tc.argsPreview)}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        // Track currently expanded turn detail row
        let currentlyExpandedTurnId = null;
        
        function toggleTurnDetail(turnId) {
            const detailRow = document.getElementById('detail-' + turnId);
            if (!detailRow) return;
            
            // If clicking on a different row, close the previously expanded one
            if (currentlyExpandedTurnId && currentlyExpandedTurnId !== turnId) {
                const prevRow = document.getElementById('detail-' + currentlyExpandedTurnId);
                if (prevRow) {
                    prevRow.classList.add('hidden');
                }
            }
            
            // Toggle current row
            const isCurrentlyHidden = detailRow.classList.contains('hidden');
            detailRow.classList.toggle('hidden');
            
            // Update tracking
            currentlyExpandedTurnId = isCurrentlyHidden ? turnId : null;
        }
        
        // Load sessions data
        async function loadSessions() {
            try {
                const response = await fetch('/metrics/api/sessions');
                const sessions = await response.json();
                renderSessions(sessions);
            } catch (e) {
                console.error('Failed to load sessions:', e);
            }
        }

        // Load OTEL linked chains data
        async function loadOtelChains() {
            try {
                const resp = await fetch('/metrics/api/otel/chains?limit=200');
                const data = await resp.json();
                renderOtelChains(data.chains || []);
            } catch (e) {
                console.error('Failed to load OTEL chains:', e);
                const tbody = document.getElementById('otel-chains-body');
                tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-4 text-center text-red-600">Failed: ${escapeHtml(e.message || 'unknown')}</td></tr>`;
            }
        }

        function renderOtelChains(chains) {
            const tbody = document.getElementById('otel-chains-body');
            if (!chains || chains.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-4 text-center text-gray-500">No OTEL chains yet</td></tr>';
                return;
            }

            tbody.innerHTML = chains.map(chain => {
                const traces = chain.traces || [];
                const first = traces[0] || {};
                const traceCount = chain.traceCount || traces.length || 0;
                const toolUse = `${chain.toolUseConsumedCount || 0} in / ${chain.toolUseEmittedCount || 0} out`;
                const toolCallsTotal = chain.toolCallsTotal || 0;
                const chainId = chain.chainId;

                return `
                <tr class="expandable-row" onclick="toggleOtelChainDetail('${chainId}')">
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatTime(chain.startTime)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${truncate(chain.userId || '-', 18)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${truncate(chain.model || '-', 24)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${traceCount}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${toolUse}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                        ${toolCallsTotal > 0 ? `<span class="tool-badge">${toolCallsTotal} calls</span>` : '<span class="text-gray-400">-</span>'}
                    </td>
                </tr>
                <tr id="otel-detail-${chainId}" class="hidden tool-call-detail">
                    <td colspan="6" class="px-4 py-3">
                        ${renderOtelChainTraces(traces)}
                    </td>
                </tr>
                `;
            }).join('');
        }

        // Track currently expanded OTEL chain detail row
        let currentlyExpandedOtelChainId = null;
        
        function toggleOtelChainDetail(chainId) {
            const detailRow = document.getElementById('otel-detail-' + chainId);
            if (!detailRow) return;
            
            // If clicking on a different row, close the previously expanded one
            if (currentlyExpandedOtelChainId && currentlyExpandedOtelChainId !== chainId) {
                const prevRow = document.getElementById('otel-detail-' + currentlyExpandedOtelChainId);
                if (prevRow) {
                    prevRow.classList.add('hidden');
                }
            }
            
            // Toggle current row
            const isCurrentlyHidden = detailRow.classList.contains('hidden');
            detailRow.classList.toggle('hidden');
            
            // Update tracking
            currentlyExpandedOtelChainId = isCurrentlyHidden ? chainId : null;
        }

        function renderOtelChainTraces(traces) {
            if (!traces || traces.length === 0) return '<div class="text-gray-500 text-sm">No traces</div>';
            return `
              <div class="space-y-3">
                ${traces.map(t => `
                  <div class="bg-white p-3 rounded border border-gray-200">
                    <div class="flex items-center justify-between">
                      <div class="text-sm">
                        <span class="text-gray-500">${formatTime(t.startTime)}</span>
                        <span class="ml-2 font-mono text-xs text-gray-600">${escapeHtml(truncate(t.traceId, 28))}</span>
                        <span class="ml-2 text-xs text-gray-500">${escapeHtml(t.route || '')}</span>
                      </div>
                      <div class="text-xs text-gray-500">
                        consumed: ${escapeHtml((t.consumed || []).length)} · emitted: ${escapeHtml((t.emitted || []).length)} · toolCalls: ${escapeHtml(t.toolCallsCount || 0)}
                      </div>
                    </div>
                    ${(t.toolCalls && t.toolCalls.length) ? `
                      <div class="mt-2">
                        <div class="text-xs font-medium text-gray-700 mb-1">Tool calls</div>
                        <div class="space-y-2">
                          ${t.toolCalls.map(tc => `
                            <div class="bg-gray-50 border border-gray-200 rounded p-2 text-xs">
                              <div class="flex items-center justify-between">
                                <div>
                                  <span class="font-medium">${escapeHtml(tc.name || '-')}</span>
                                  ${tc.id ? `<span class="ml-2 font-mono text-gray-600">${escapeHtml(tc.id)}</span>` : ''}
                                </div>
                                <div class="text-gray-600">
                                  ${tc.filePath ? `<span class="font-mono">${escapeHtml(truncate(tc.filePath, 60))}</span>` : ''}
                                </div>
                              </div>
                              ${(tc.startLine || tc.endLine) ? `<div class="text-gray-600 mt-1">L${tc.startLine || 0}-${tc.endLine || 0} · +${tc.linesAdded || 0} -${tc.linesRemoved || 0}</div>` : ''}
                            </div>
                          `).join('')}
                        </div>
                      </div>
                    ` : '<div class="mt-2 text-xs text-gray-500">No tool call summary recorded</div>'}
                  </div>
                `).join('')}
              </div>
            `;
        }
        
        function renderSessions(sessions) {
            const tbody = document.getElementById('sessions-body');
            if (sessions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-4 text-center text-gray-500">No sessions yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = sessions.map(s => `
                <tr class="expandable-row hover:bg-blue-50 cursor-pointer" onclick="loadSessionTurns('${escapeHtml(s.sessionId)}')">
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-blue-600">${truncate(s.userId, 25)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatTime(s.startTime)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatTime(s.lastActivityTime)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">${s.turnCount} messages</span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${s.totalToolCalls}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${s.avgToolCallsPerTurn.toFixed(1)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                        <span class="text-purple-600">${(s.totalPromptTokens || 0).toLocaleString()}</span> / <span class="text-orange-600">${(s.totalCompletionTokens || 0).toLocaleString()}</span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-green-600">${s.totalLinesModified}</td>
                </tr>
            `).join('');
        }
        
        async function loadSessionTurns(sessionId) {
            try {
                const response = await fetch(`/metrics/api/sessions/${sessionId}/turns`);
                const turns = await response.json();
                showModal(sessionId, turns);
            } catch (e) {
                console.error('Failed to load session turns:', e);
            }
        }
        
        function showModal(sessionId, turns) {
            const modal = document.getElementById('tool-detail-modal');
            const content = document.getElementById('modal-content');
            
            // Calculate summary stats
            const totalToolCalls = turns.reduce((sum, t) => sum + (Number(t.toolCalls) || 0), 0);
            const totalTokens = turns.reduce((sum, t) => sum + (Number(t.promptTokens) || 0) + (Number(t.completionTokens) || 0), 0);
            
            content.innerHTML = `
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-2">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">User Session</h3>
                            <p class="text-sm text-gray-500 font-mono mt-1">${escapeHtml(sessionId)}</p>
                        </div>
                        <div class="flex items-center space-x-4 text-sm">
                            <div class="text-center">
                                <div class="font-semibold text-gray-900">${turns.length}</div>
                                <div class="text-gray-500">Messages</div>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-blue-600">${totalToolCalls}</div>
                                <div class="text-gray-500">Tool Calls</div>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-purple-600">${totalTokens.toLocaleString()}</div>
                                <div class="text-gray-500">Tokens</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="space-y-4 max-h-[60vh] overflow-y-auto">
                    ${turns.length === 0 ? '<div class="text-gray-500 text-center py-8">No messages in this session</div>' : turns.map((turn, index) => `
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center space-x-3">
                                    <span class="flex items-center justify-center w-6 h-6 rounded-full bg-blue-100 text-blue-800 text-xs font-semibold">${index + 1}</span>
                                    <div>
                                        <div class="text-sm text-gray-500">${formatTime(turn.timestamp)}</div>
                                        <div class="text-xs text-gray-400 font-mono">${turn.model || 'unknown'}</div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    ${Number(turn.toolCalls) > 0 ? `<span class="tool-badge">${turn.toolCalls} tool${Number(turn.toolCalls) > 1 ? 's' : ''}</span>` : ''}
                                    ${turn.latencyMs ? `<span class="text-xs text-gray-500">${turn.latencyMs}ms</span>` : ''}
                                </div>
                            </div>
                            
                            ${turn.lastUserMessagePreview ? `
                                <div class="mb-3 p-3 bg-gray-50 rounded border border-gray-200">
                                    <div class="text-xs text-gray-500 uppercase font-semibold mb-1">User Message</div>
                                    <div class="text-sm text-gray-700">${escapeHtml(turn.lastUserMessagePreview)}</div>
                                </div>
                            ` : ''}
                            
                            ${turn.promptTokens || turn.completionTokens ? `
                                <div class="text-xs text-gray-500 mb-2">
                                    Tokens: <span class="text-purple-600">${turn.promptTokens || 0}</span> in / <span class="text-orange-600">${turn.completionTokens || 0}</span> out
                                </div>
                            ` : ''}
                            
                            ${turn.toolCalls && turn.toolCalls.length > 0 ? `
                                <div class="mt-3 border-t pt-3">
                                    ${renderToolCalls(turn.toolCalls)}
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        function closeModal() {
            const modal = document.getElementById('tool-detail-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        
        // Utility functions
        function formatTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
        
        function truncate(str, len) {
            if (!str) return '-';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }
        
        function escapeHtml(str) {
            if (!str && str !== 0) return '';
            str = String(str);
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }
        
        // Load tool performance data
        async function loadToolPerformance() {
            try {
                const response = await fetch('/metrics/api/tools/performance');
                const tools = await response.json();
                renderToolPerformance(tools);
            } catch (e) {
                console.error('Failed to load tool performance:', e);
            }
        }
        
        function renderToolPerformance(tools) {
            const tbody = document.getElementById('tools-body');
            if (tools.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No tool calls yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = tools.map((tool, index) => {
                const successRate = tool.successRate.toFixed(1);
                const calls = tool.calls.toLocaleString();
                const isEditTool = tool.isEditTool;
                const isSkill = tool.isSkill;
                const linesAdded = tool.linesAdded || 0;
                const linesRemoved = tool.linesRemoved || 0;
                
                // Color coding based on success rate
                let successClass = 'text-green-600';
                if (successRate < 90) successClass = 'text-yellow-600';
                if (successRate < 70) successClass = 'text-red-600';
                
                // Alternate row background for better readability
                const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                return `
                <tr class="${rowClass} hover:bg-blue-50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <span class="text-sm font-medium text-gray-900">${escapeHtml(tool.toolName)}</span>
                            ${isEditTool ? '<span class="ml-2 px-2 py-0.5 text-xs rounded bg-green-100 text-green-800">edit</span>' : ''}
                            ${isSkill ? '<span class="ml-2 px-2 py-0.5 text-xs rounded bg-purple-100 text-purple-800">skill</span>' : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        <span class="text-sm font-semibold text-blue-600">${calls}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        <span class="text-sm font-semibold ${successClass}">${successRate}%</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                        ${isEditTool 
                            ? `<span class="text-green-600 font-medium">+${linesAdded.toLocaleString()}</span> <span class="text-red-600 font-medium">-${linesRemoved.toLocaleString()}</span>`
                            : '<span class="text-gray-400">-</span>'}
                    </td>
                </tr>
                `;
            }).join('');
        }
        
        // Load skills data
        async function loadSkills() {
            try {
                const response = await fetch('/metrics/api/skills/statistics');
                const skills = await response.json();
                renderSkills(skills);
            } catch (e) {
                console.error('Failed to load skills:', e);
            }
        }
        
        function renderSkills(skills) {
            const tbody = document.getElementById('skills-body');
            
            // Update summary cards
            if (skills.length === 0) {
                document.getElementById('total-skills').textContent = '0';
                document.getElementById('total-skill-calls').textContent = '0';
                document.getElementById('avg-skill-success').textContent = '-';
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No skills used yet</td></tr>';
                return;
            }
            
            // Calculate summary stats
            const totalSkills = skills.length;
            const totalCalls = skills.reduce((sum, s) => sum + s.calls, 0);
            const avgSuccess = skills.reduce((sum, s) => sum + s.successRate, 0) / totalSkills;
            
            document.getElementById('total-skills').textContent = totalSkills.toLocaleString();
            document.getElementById('total-skill-calls').textContent = totalCalls.toLocaleString();
            document.getElementById('avg-skill-success').textContent = avgSuccess.toFixed(1) + '%';
            
            // Render table
            tbody.innerHTML = skills.map((skill, index) => {
                const successRate = skill.successRate.toFixed(1);
                const calls = skill.calls.toLocaleString();
                const lastUsed = skill.lastUsed ? formatTime(skill.lastUsed) : '-';
                
                // Color coding based on success rate
                let successClass = 'text-green-600';
                if (successRate < 90) successClass = 'text-yellow-600';
                if (successRate < 70) successClass = 'text-red-600';
                
                // Alternate row background for better readability
                const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                return `
                <tr class="${rowClass} hover:bg-purple-50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <svg class="w-4 h-4 text-purple-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"></path>
                            </svg>
                            <span class="text-sm font-medium text-gray-900">${escapeHtml(skill.skillName)}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        <span class="text-sm font-semibold text-purple-600">${calls}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        <span class="text-sm font-semibold ${successClass}">${successRate}%</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-500">
                        ${lastUsed}
                    </td>
                </tr>
                `;
            }).join('');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadTurns();
        });
        
        // Auto-refresh every 10 seconds
        setInterval(() => {
            const activeTab = document.querySelector('.tab-active').id.replace('tab-', '');
            if (activeTab === 'turns') loadTurns();
            if (activeTab === 'otel') loadOtelChains();
            if (activeTab === 'sessions') loadSessions();
            if (activeTab === 'tools') loadToolPerformance();
            if (activeTab === 'skills') loadSkills();
        }, 10000);
        
        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeModal();
        });

        // jQuery tooltip for message preview
        $(document).ready(function() {
            // Create tooltip element
            const $tooltip = $('<div class="message-full-tooltip"></div>').appendTo('body');

            // Cache full messages by turnId (avoid refetching)
            const fullMessageCache = new Map();

            // Handle hover on message preview cells
            $(document).on('mouseenter', '.message-preview-cell', function(e) {
                const $cell = $(this);
                const turnId = $cell.data('turn-id');
                const previewMessage = $cell.data('preview-message');

                if (!turnId) {
                    if (previewMessage && previewMessage !== '-') {
                        $tooltip.text(previewMessage).show();
                        positionTooltip(e);
                    }
                    return;
                }

                const cached = fullMessageCache.get(turnId);
                if (cached) {
                    $tooltip.text(cached).show();
                    positionTooltip(e);
                    return;
                }

                // Show immediately (preview) while fetching full message
                if (previewMessage && previewMessage !== '-') {
                    $tooltip.text(previewMessage).show();
                    positionTooltip(e);
                }

                // fetch(`/metrics/api/turns/${encodeURIComponent(turnId)}`)
                //     .then(r => r.json())
                //     .then(data => {
                //         const full = (data && data.lastUserMessage) ? String(data.lastUserMessage) : null;
                //         if (full && full.trim().length > 0) {
                //             fullMessageCache.set(turnId, full);
                //             // Only update tooltip if still hovering this cell
                //             if ($cell.is(':hover')) {
                //                 $tooltip.text(full).show();
                //             }
                //         }
                //     })
                //     .catch(() => {
                //         // ignore; keep preview
                //     });
            });

            $(document).on('mousemove', '.message-preview-cell', function(e) {
                if ($tooltip.is(':visible')) {
                    positionTooltip(e);
                }
            });

            $(document).on('mouseleave', '.message-preview-cell', function() {
                $tooltip.hide();
            });

            function positionTooltip(e) {
                const tooltipWidth = $tooltip.outerWidth();
                const tooltipHeight = $tooltip.outerHeight();
                const windowWidth = $(window).width();
                const windowHeight = $(window).height();

                let left = e.pageX + 15;
                let top = e.pageY + 15;

                // Adjust if tooltip goes off right edge
                if (left + tooltipWidth > windowWidth) {
                    left = e.pageX - tooltipWidth - 15;
                }

                // Adjust if tooltip goes off bottom edge
                if (top + tooltipHeight > windowHeight + $(window).scrollTop()) {
                    top = e.pageY - tooltipHeight - 15;
                }

                $tooltip.css({ left: left + 'px', top: top + 'px' });
            }
        });
    </script>
</body>
</html>
